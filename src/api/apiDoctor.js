import axiosClient from "./axiosClient";

const apiDoctor = {
  // =================== DOCTOR PROFILE ===================
  getMyProfile: async () => {
    try {
      console.log("üîç [apiDoctor] L·∫•y profile b√°c sƒ©...");
      const response = await axiosClient.get("/api/profiles/doctor/me");
      console.log("‚úÖ [apiDoctor] Profile b√°c sƒ©:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói l·∫•y profile:", error);
      throw error;
    }
  },

  updateMyProfile: async (profileData) => {
    try {
      console.log("üîÑ [apiDoctor] C·∫≠p nh·∫≠t profile b√°c sƒ©...", profileData);
      const response = await axiosClient.put(
        "/api/profiles/doctor/me",
        profileData
      );
      console.log("‚úÖ [apiDoctor] C·∫≠p nh·∫≠t th√†nh c√¥ng:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói c·∫≠p nh·∫≠t profile:", error);
      throw error;
    }
  },

  // =================== DASHBOARD STATISTICS ===================
  getDashboardStats: async () => {
    try {
      console.log("üìä [apiDoctor] L·∫•y th·ªëng k√™ dashboard...");

      // L·∫•y danh s√°ch b·ªánh nh√¢n tr∆∞·ªõc ƒë·ªÉ c√≥ d·ªØ li·ªáu c∆° b·∫£n
      const patientsResponse = await apiDoctor.getMyPatients();
      const patients = patientsResponse || [];

      // L·∫•y doctorId t·ª´ localStorage
      const user = localStorage.getItem("user");
      let doctorId = null;

      if (user) {
        try {
          const userData = JSON.parse(user);
          doctorId = userData.id;
        } catch (e) {
          console.error("‚ùå [apiDoctor] L·ªói parse user data:", e);
        }
      }

      // T√≠nh to√°n th·ªëng k√™ c∆° b·∫£n t·ª´ danh s√°ch b·ªánh nh√¢n
      const totalPatients = patients.length;

      // Th·ª≠ l·∫•y th√™m d·ªØ li·ªáu t·ª´ treatment phases n·∫øu c√≥
      let treatmentPhases = [];
      if (doctorId) {
        try {
          const phasesResponse = await axiosClient.get(
            `/api/treatment-workflow/doctor/${doctorId}/treatment-phases`
          );
          treatmentPhases = phasesResponse.data || [];
          console.log(
            "‚úÖ [apiDoctor] Treatment phases loaded:",
            treatmentPhases.length
          );
        } catch (error) {
          console.warn(
            "‚ö†Ô∏è [apiDoctor] Kh√¥ng th·ªÉ l·∫•y treatment phases:",
            error.message
          );
        }
      }

      // T√≠nh to√°n th·ªëng k√™ chi ti·∫øt
      const today = new Date().toDateString();

      // L·ªãch h·∫πn h√¥m nay (t·ª´ treatment phases ho·∫∑c appointments)
      const todayAppointments = treatmentPhases.filter(
        (phase) =>
          phase.startDate && new Date(phase.startDate).toDateString() === today
      ).length;

      // B·ªánh nh√¢n ƒëang ƒëi·ªÅu tr·ªã (c√≥ treatment plan active)
      const inTreatment = treatmentPhases.filter(
        (phase) => phase.status === "In Progress"
      ).length;

      // B·ªánh nh√¢n ƒë√£ ho√†n th√†nh ƒëi·ªÅu tr·ªã
      const completed = treatmentPhases.filter(
        (phase) => phase.status === "Completed"
      ).length;

      // T√≠nh t·ªâ l·ªá th√†nh c√¥ng
      const totalPhases = treatmentPhases.length;
      const successRate =
        totalPhases > 0 ? Math.round((completed / totalPhases) * 100) : 0;

      // N·∫øu kh√¥ng c√≥ treatment phases, t√≠nh to√°n t·ª´ profile status c·ªßa patients
      let fallbackInTreatment = 0;
      let fallbackCompleted = 0;

      if (totalPhases === 0 && patients.length > 0) {
        patients.forEach((patient) => {
          if (
            patient.status === "active" ||
            patient.profileStatus === "active"
          ) {
            fallbackInTreatment++;
          } else if (
            patient.status === "completed" ||
            patient.profileStatus === "completed"
          ) {
            fallbackCompleted++;
          }
        });
      }

      const stats = {
        totalPatients: totalPatients,
        todayAppointments: todayAppointments,
        inTreatment: totalPhases > 0 ? inTreatment : fallbackInTreatment,
        completed: totalPhases > 0 ? completed : fallbackCompleted,
        successRate:
          totalPhases > 0
            ? successRate
            : totalPatients > 0
            ? Math.round((fallbackCompleted / totalPatients) * 100)
            : 0,
      };

      console.log("‚úÖ [apiDoctor] Th·ªëng k√™ dashboard:", stats);
      return stats;
    } catch (error) {
      console.warn(
        "‚ö†Ô∏è [apiDoctor] Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh:",
        error.message
      );

      // Tr·∫£ v·ªÅ th·ªëng k√™ m·∫∑c ƒë·ªãnh thay v√¨ throw error
      const defaultStats = {
        totalPatients: 0,
        todayAppointments: 0,
        inTreatment: 0,
        completed: 0,
        successRate: 0,
      };

      console.log("‚úÖ [apiDoctor] S·ª≠ d·ª•ng th·ªëng k√™ m·∫∑c ƒë·ªãnh:", defaultStats);
      return defaultStats;
    }
  },

  // =================== PATIENT MANAGEMENT ===================
  getMyPatients: async () => {
    try {
      console.log("üë• [apiDoctor] L·∫•y danh s√°ch b·ªánh nh√¢n...");
      const response = await axiosClient.get(
        "/api/doctor/schedule/my-patients"
      );
      console.log("‚úÖ [apiDoctor] Danh s√°ch b·ªánh nh√¢n:", response.data);

      // Transform data t·ª´ API response th√†nh format mong mu·ªën
      const patients = response.data.patients.map((patient) => ({
        id: patient.patientId,
        fullName: patient.fullName,
        age: patient.dateOfBirth
          ? new Date().getFullYear() -
            new Date(patient.dateOfBirth).getFullYear()
          : null,
        gender: patient.gender,
        dateOfBirth: patient.dateOfBirth,
        phone: patient.phone,
        email: patient.email,
        status: patient.profileStatus || "active",
        treatmentType: "IVF", // C√≥ th·ªÉ l·∫•y t·ª´ treatment plan sau
        nextAppointment: patient.latestAppointment,
        progress: apiDoctor.calculateProgressFromPhase(patient.profileStatus),
        servicePackage: "IVF_PREMIUM", // C√≥ th·ªÉ l·∫•y t·ª´ treatment plan sau
        createdAt: patient.latestAppointment,
        appointmentCount: patient.appointmentCount,
        latestAppointmentStatus: patient.latestAppointmentStatus,
        maritalStatus: patient.maritalStatus,
        healthBackground: patient.healthBackground,
        notes: patient.notes,
        avatarUrl: patient.avatarUrl,
        address: patient.address,
      }));

      return patients;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói l·∫•y danh s√°ch b·ªánh nh√¢n:", error);
      throw error;
    }
  },

  getPatientDetails: async (patientId) => {
    try {
      console.log(`üë§ [apiDoctor] L·∫•y chi ti·∫øt b·ªánh nh√¢n ${patientId}...`);
      const response = await axiosClient.get(`/api/patients/${patientId}`);
      console.log("‚úÖ [apiDoctor] Chi ti·∫øt b·ªánh nh√¢n:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói l·∫•y chi ti·∫øt b·ªánh nh√¢n:", error);
      throw error;
    }
  },

  // =================== APPOINTMENTS ===================
  getTodayAppointments: async () => {
    try {
      console.log("üìÖ [apiDoctor] L·∫•y l·ªãch h·∫πn h√¥m nay...");

      // L·∫•y doctorId t·ª´ localStorage
      const user = localStorage.getItem("user");
      let doctorId = null;

      if (user) {
        try {
          const userData = JSON.parse(user);
          doctorId = userData.id;
        } catch (e) {
          console.error("‚ùå [apiDoctor] L·ªói parse user data:", e);
        }
      }

      // Th·ª≠ l·∫•y appointments t·ª´ treatment phases tr∆∞·ªõc
      let todayAppointments = [];
      if (doctorId) {
        try {
          const response = await axiosClient.get(
            `/api/treatment-workflow/doctor/${doctorId}/treatment-phases`
          );
          const phases = response.data || [];
          console.log("‚úÖ [apiDoctor] Treatment phases loaded:", phases.length);

          // L·ªçc phases h√¥m nay
          const today = new Date().toDateString();
          const todayPhases = phases.filter(
            (phase) =>
              phase.startDate &&
              new Date(phase.startDate).toDateString() === today
          );

          // Transform th√†nh format l·ªãch h·∫πn
          todayAppointments = todayPhases.map((phase) => ({
            id: phase.phaseId || `phase-${Date.now()}`,
            time: phase.startDate
              ? new Date(phase.startDate).toLocaleTimeString("vi-VN", {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "09:00",
            patientName: `B·ªánh nh√¢n ${phase.patientId}`,
            service: phase.phaseName || "Kh√°m l√¢m s√†ng",
            status: phase.status || "Scheduled",
            type: "Treatment",
            notes: phase.description || "",
          }));
        } catch (error) {
          console.warn(
            "‚ö†Ô∏è [apiDoctor] Kh√¥ng th·ªÉ l·∫•y treatment phases:",
            error.message
          );
        }
      }

      // N·∫øu kh√¥ng c√≥ appointments t·ª´ treatment phases, t·∫°o d·ªØ li·ªáu m·∫´u t·ª´ patients
      if (todayAppointments.length === 0) {
        try {
          const patientsResponse = await apiDoctor.getMyPatients();
          const patients = patientsResponse || [];

          // T·∫°o l·ªãch h·∫πn m·∫´u cho 2-3 b·ªánh nh√¢n ƒë·∫ßu ti√™n
          const sampleTimes = ["09:00", "10:30", "14:00"];
          todayAppointments = patients.slice(0, 3).map((patient, index) => ({
            id: `appointment-${patient.id}-${Date.now()}`,
            time: sampleTimes[index] || "09:00",
            patientName: patient.fullName || `B·ªánh nh√¢n ${patient.id}`,
            service: "Kh√°m l√¢m s√†ng",
            status: "Scheduled",
            type: "Consultation",
            notes: "L·ªãch h·∫πn kh√°m ƒë·ªãnh k·ª≥",
          }));
        } catch (error) {
          console.warn(
            "‚ö†Ô∏è [apiDoctor] Kh√¥ng th·ªÉ t·∫°o appointments m·∫´u:",
            error.message
          );
        }
      }

      console.log("‚úÖ [apiDoctor] L·ªãch h·∫πn h√¥m nay:", todayAppointments.length);
      return todayAppointments;
    } catch (error) {
      console.warn(
        "‚ö†Ô∏è [apiDoctor] Kh√¥ng th·ªÉ l·∫•y l·ªãch h·∫πn, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh:",
        error.message
      );

      // Tr·∫£ v·ªÅ l·ªãch h·∫πn m·∫´u thay v√¨ throw error
      const defaultAppointments = [
        {
          id: "default-1",
          time: "09:00",
          patientName: "B·ªánh nh√¢n m·∫´u 1",
          service: "Kh√°m l√¢m s√†ng",
          status: "Scheduled",
          type: "Consultation",
          notes: "L·ªãch h·∫πn kh√°m ƒë·ªãnh k·ª≥",
        },
        {
          id: "default-2",
          time: "10:30",
          patientName: "B·ªánh nh√¢n m·∫´u 2",
          service: "T∆∞ v·∫•n ƒëi·ªÅu tr·ªã",
          status: "Scheduled",
          type: "Consultation",
          notes: "T∆∞ v·∫•n ph√°c ƒë·ªì ƒëi·ªÅu tr·ªã",
        },
      ];

      console.log(
        "‚úÖ [apiDoctor] S·ª≠ d·ª•ng l·ªãch h·∫πn m·∫∑c ƒë·ªãnh:",
        defaultAppointments.length
      );
      return defaultAppointments;
    }
  },

  getMySchedule: async () => {
    try {
      console.log("üìã [apiDoctor] L·∫•y l·ªãch tr√¨nh b√°c sƒ©...");
      const response = await axiosClient.get("/api/doctor/schedule");
      console.log("‚úÖ [apiDoctor] L·ªãch tr√¨nh:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói l·∫•y l·ªãch tr√¨nh:", error);
      throw error;
    }
  },

  // =================== TREATMENT MANAGEMENT ===================
  createTreatmentPlan: async (treatmentData) => {
    try {
      console.log("üìù [apiDoctor] T·∫°o ph√°c ƒë·ªì ƒëi·ªÅu tr·ªã...", treatmentData);
      const response = await axiosClient.post(
        "/api/treatment-plans",
        treatmentData
      );
      console.log("‚úÖ [apiDoctor] T·∫°o ph√°c ƒë·ªì th√†nh c√¥ng:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói t·∫°o ph√°c ƒë·ªì:", error);
      throw error;
    }
  },

  updateTreatmentProgress: async (patientId, progressData) => {
    try {
      console.log(
        `üîÑ [apiDoctor] C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô ƒëi·ªÅu tr·ªã cho b·ªánh nh√¢n ${patientId}...`
      );
      const response = await axiosClient.put(
        `/api/treatment-plans/${patientId}/progress`,
        progressData
      );
      console.log("‚úÖ [apiDoctor] C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô th√†nh c√¥ng:", response.data);
      return response.data;
    } catch (error) {
      console.error("‚ùå [apiDoctor] L·ªói c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô:", error);
      throw error;
    }
  },

  // =================== UTILITY FUNCTIONS ===================
  transformPatientData: (rawPatient) => {
    // Transform API response to match UI expectations
    const transformed = {
      id: rawPatient.id || rawPatient.patientId,
      name:
        rawPatient.fullName ||
        rawPatient.name ||
        `B·ªánh nh√¢n ${rawPatient.id || rawPatient.patientId}`,
      fullName:
        rawPatient.fullName ||
        rawPatient.name ||
        `B·ªánh nh√¢n ${rawPatient.id || rawPatient.patientId}`,
      age:
        rawPatient.age ||
        (rawPatient.dateOfBirth
          ? new Date().getFullYear() -
            new Date(rawPatient.dateOfBirth).getFullYear()
          : 30), // Default age if not available
      gender: rawPatient.gender?.toLowerCase() || "unknown",
      dob: rawPatient.dateOfBirth,
      contact: rawPatient.phone || rawPatient.contact,
      email: rawPatient.email,
      status: rawPatient.status || rawPatient.profileStatus || "active",
      treatmentType:
        rawPatient.treatmentType || rawPatient.serviceName || "IVF",
      nextAppointment:
        rawPatient.nextAppointment || rawPatient.latestAppointment,
      progress:
        rawPatient.progress ||
        apiDoctor.calculateProgressFromPhase(
          rawPatient.status || rawPatient.profileStatus
        ),
      servicePackage:
        rawPatient.servicePackage || rawPatient.serviceName || "IVF_PREMIUM",
      createdAt: rawPatient.createdAt,
    };

    console.log("üîÑ [apiDoctor] Transformed patient data:", transformed);
    return transformed;
  },

  // Helper function ƒë·ªÉ t√≠nh progress t·ª´ profile status
  calculateProgressFromPhase: (status) => {
    switch (status) {
      case "pending":
        return 10;
      case "active":
        return 50;
      case "completed":
        return 100;
      case "cancelled":
        return 0;
      case "inactive":
        return 0;
      default:
        return 25; // Default progress for active patients
    }
  },
};

export default apiDoctor;
